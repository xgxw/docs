= 关于微信小程序登录的思考

tag: '微信小程序', '登录', '流程设计'

本文主要介绍微信小程序的登录流程设计, 以及常规登录流程设计.

== 登录方式
一般而言, 登录方式有如下几种

1. 密码登录. 用户需要先注册, 然后登录. 密码通过加密后上传到服务端, 服务端解密后判断是否正确.
  .. 一般而言, 服务端不存储真实密码, 而是存储密码经过不对称加密后的字符串, 所以服务端是不知道你的密码的.
2. 验证码登录. 目前采用较多. 验证码登录时, 注册/登录可以是一体的, 即服务端可以自动根据手机号注册用户. 
  .. 企业非常喜欢验证码登录. 这种方式下, 企业可以准确获得用户的真实手机号, 可以更好的在不同平台关联用户.
3. OA 认证. 基于第三方登录, 如国内目前流行的通过微信/支付宝OA认证登录.
4. 小程序登录. 微信小程序有其独有的逻辑. 这个后边再讲.

OA认证具体的流程和原理参考其他文章.

== 登录状态
一般而言, 有两种方式记录登录状态

1. token. token是一个字符串, 当用户登录后, 服务端生成一个token返回给前端. 前端请求数据时, 将token放入Request, 后端从Request中取出, 解密token获取记录的数据, 从而验证登录状态.
  .. 一般而言, 前端获取token后, 会将其存储在cookie或者localstorage中, 以方便下次使用.
  .. token一般由 userID/有效时间 数组组成, 加密后返回给前端.
2. session. session是一个结构体, 由服务端保存, 一般保存在redis中. 当用户登录后, 服务端生成session并保存, 然后将 session.ID 返回给前端, 剩余的流程就合token比较类似了.

.一般情况下session的方式更好, 功能更强大. 对比如下
1. session可以缓存更多的信息. 因为session是服务端保存的, 前后端交互只需要传递sid即可, 所以session中可以加入很多数据.
2. session可以更简单的实现单点登录. 因为token是无状态的, 只要符合加解密规则就认为合法, 无法使原来的session失效.
3. 总体而言, session更强大, 但实现较token复杂一点, 且需要增加缓存. 可以根据需要选择.

'''
如上讲的, session/token 介绍和区别 网上的文章已经烂大街了, 接下来主要分析前端如何处理比较优雅. 假设我们用的sid(其实都一样)

一般而言, 前端我们会分为三层(vue项目): views/store/ajax. 那么, 我们将 sid 放在哪里合适呢?

先说我的回答, 我建议放在 ajax 层, 将用户鉴权的逻辑对上层是透明的, 即 views/store 层不需要考虑鉴权(sid)的问题. 我认为, 当用户登录后, 前端操作数据时, 默认的就是当前用户再操作, 所以上层不应该将 userID 等用户标示信息特意放到请求中, 而是由请求层(ajax)全权处理.

== 登录流程设计

.微信小程序的登录流程为:
. 用户启动小程序, 程序自动发起登录流程.
. 调用 store.CheckState 检查是否登录: 检查有无sid
  .. 有: 直接fetch用户信息. fetch提示认证失败则重新触发登录流程.
  .. 无: 触发登录流程
    ... 调用 wx.login() 获取wxsession. wxsession 用处参考官方文档.
    ... 用户点击按钮, 授权使用手机号, 获取加密后的手机号信息. 此时后端可以根据 wxsession和加密数据 获取手机号, 从而实现注册登录.
    ... 注册/登录成功, 前端存储sid.
    ... ajax层 根据路由, 自己决定请求时是否附带sid, store不需要考虑sid相关的事情.

上述流程是我们直观看到的, 想到的准确的流程, 但是实施时可以有一些小优化, 简化代码逻辑, 从而使代码更优雅.

.简化后的逻辑
. 用户启动小程序, 程序自动发起登录流程.
. store.fetch 调用 ajax.fetch. 
  .. fetch 成功, 结束流程.
  .. fetch 失败, 返回未认证.
    ... store 触发 wx.login, 获取并设置 wx_session.
    ... 用户点击按钮, 授权使用手机号, 获取加密后的手机号信息. 此时后端可以根据 wxsession和加密数据 获取手机号, 从而实现注册登录.
      ... 注意, login时要验证 wx_session 是否有效, 失效的话重新获取一边即可.

简而言之, 就是将验证是否登录, 存储sid的逻辑全部放到了ajax层, store层只做数据/业务的逻辑.
